
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>中文口語發音練習（Book2_A2）</title>
  <style>
    body { font-family: "Microsoft JhengHei", Arial, sans-serif; background:#fafafa; margin:0; padding:20px; }
    .container { max-width: 980px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,.08); }
    h1 { text-align:center; margin-top:0; color:#333; }
    h2 { margin-top:28px; }
    button, input[type="text"] { padding:8px 12px; margin:5px; font-size:16px; }
    .sentence { font-size:20px; text-align:center; margin:20px 0; padding:10px; background:#f1f1f1; border-radius:8px; }
    #result, #diff, #quizDiff, .box { padding:10px; margin-top:10px; background:#f9f9f9; border:1px solid #ddd; min-height:30px; border-radius:8px; }
    .row { margin:6px 0; }
    .label { color:#666; font-size:14px; margin-right:6px; }
    .highlight { background:yellow; font-weight:bold; }
    .ok { background:rgba(22,163,74,.12); }
    .note { color:#6b7280; font-size:12px; }
    .scoreRow { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    #feedback { color:#374151; font-size:15px; }
    .muted { color:#6b7280; }
    .flex { display:flex; gap:20px; flex-wrap:wrap; }
    .col { flex:1 1 380px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #eaeaea; padding:8px; text-align:left; vertical-align:top; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .em { font-weight:600; }
    .pill { display:inline-block; background:#eef2ff; padding:2px 8px; border-radius:999px; font-size:12px; margin:2px 6px 2px 0; }
    .list { display:flex; flex-wrap:wrap; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .wide { width:100%; }
    .checks { max-height: 240px; overflow:auto; border:1px solid #e5e7eb; padding:8px; border-radius:8px; background:#fff; }
    .check-item { display:flex; align-items:center; gap:8px; padding:4px 0; }
    .muted-small { color:#9ca3af; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>中文口語發音練習（Book2_A2）</h1>

    <div class="box two">
      <div>
        <label class="label">姓名：</label>
        <input type="text" id="studentName" placeholder="可留空" class="wide" />
      </div>
      <div>
        <label class="label">學號：</label>
        <input type="text" id="studentId" placeholder="可留空" class="wide" />
      </div>
    </div>

    <h2>選擇課次（可複選）</h2>
    <div class="box">
      <div class="actions">
        <button onclick="checkAllLessons()">全選</button>
        <button onclick="uncheckAllLessons()">清空</button>
      </div>
      <div id="lessonChecks" class="checks"></div>
      <div class="muted-small">已選課次：<span id="selCount">0</span>；可用句子：<span id="sentCount">0</span></div>
    </div>

    <div class="flex">
      <div class="col">
        <h2>練習（抽選「例句」）</h2>
        <div class="actions">
          <button onclick="newSentence()">換一句</button>
        </div>

        <div class="sentence" id="sentence">請按「換一句」生成句子（需先勾課次）</div>

        <div class="actions">
          <button id="btnStart" onclick="startRecognition()">🎙️ 開始錄音</button>
          <button id="btnStop" onclick="stopRecognition()" disabled>■ 結束錄音</button>
          <button onclick="playSentence()">🔊 示範發音</button>
        </div>

        <h3>辨識結果：</h3>
        <div id="result">尚無結果</div>

        <h3>差異高光：</h3>
        <div id="diff">尚無結果</div>
        <div class="note">說明：綠底為一致，高光為不同；例句缺漏以 <b>∅</b> 顯示，辨識多唸會在「辨識」行以高光顯示。</div>

        <h3>正確率：</h3>
        <div class="scoreRow">
          <div id="accuracy">—</div>
          <div id="feedback"></div>
          <button id="btnDownload" onclick="downloadTxt()">⬇️ 下載成績（TXT）</button>
        </div>
      </div>

      <div class="col">
        <h2>測驗（從所選課次的例句抽題，共 3 題）</h2>
        <div class="box">
          <div class="muted">狀態：<span id="quizState">未開始</span></div>
          <div class="sentence" id="quizSentence">（開始後顯示本題句子）</div>

          <div class="actions">
            <button onclick="startQuiz()">1開始測驗（3題）</button>
            <button onclick="quizPlay()">🔊 示範發音</button>
            <button id="btnQuizStart" onclick="quizRecord()">🎙️ 2開始錄音</button>
            <button id="btnQuizStop" onclick="quizStop()" disabled>■ 結束錄音</button>
            <button onclick="quizSubmit()">3送出</button>
          </div>

          <div class="row"><span class="label">本題辨識：</span><span id="quizHeard">—</span></div>
          <div id="quizDiff">（高光差異會顯示在這裡）</div>
        </div>

        <div id="quizSummary" class="box" style="display:none;">
          <h3>本次測驗結果</h3>
          <div class="row">總正確率：<b id="quizTotal">—</b></div>
          <div class="row">總評（中 / EN）：<span id="quizFeedback" class="em">—</span></div>
          <div class="row">姓名 / 學號：<span id="quizWho" class="em">—</span></div>
          <div class="actions">
            <button onclick="downloadQuizTXT()">⬇️ 下載成績（TXT）</button>
            <button onclick="downloadQuizCSV()">⬇️ 下載成績（CSV）</button>
          </div>

          <h4>辨識比對表（3題）</h4>
          <table id="quizTable">
            <thead>
              <tr>
                <th style="width:40px;">題</th>
                <th>例句 / 辨識（雙行高光）</th>
                <th style="width:80px;">正確率</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  const lessons = {
  "1": [
    "我們一起走到公園裡散步。",
    "那位路人熱心地告訴我們便利商店在哪裡。",
    "你需要我幫忙拿行李嗎？",
    "請問你知道學校在哪裡嗎?我迷路了。",
    "下一個路口左轉，餐廳就到了。",
    "這個路口的車子很多，你得小心。",
    "郵局在中山路四段三十號。",
    "咖啡店不太遠，你過了紅綠燈再右轉就到了。",
    "公園在第幾個路口？",
    "一定要等紅綠燈變綠再過馬路才安全。",
    "請你告訴我最近的飲料店在哪裡。",
    "我想提錢，可是這附近沒有提款機。",
    "下課後，我們常常去超商買零食。",
    "他應該已經下課了，怎麼還沒回家？",
    "她把信帶到郵局寄了。",
    "他想提十萬塊錢付學費，所以得去銀行。",
    "那邊的風景非常漂亮。",
    "師大的學生畢業以後都想當老師嗎?",
    "和平東路上有一家很有名的小吃店。",
    "從這裡往前走，差不多三分鐘就到捷運站了。",
    "在咖啡店門口右轉，就會看到一座公園。",
    "火車站聽起來不太遠，我們走路去吧。",
    "我在路上看見小美跟一個男生在聊天。",
    "我正在下載最新的遊戲。",
    "爬山前別忘了下載離線地圖。",
    "這支手機有一點貴，可是非常好用。",
    "他穿著一件紅色的外套。",
    "我能在超商買日用品嗎?",
    "我經過那家新開的書店的時候，看到了我的老師。",
    "那間咖啡廳在一條小小的巷子裡。",
    "上完一整天的課，我快餓死了。",
    "他一邊聽音樂，一邊做作業。",
    "我今天才發現走這條路也可以到學校。",
    "火車站離學校只要五分鐘，不太遠。",
    "她的背包很大，可以裝很多東西。",
    "我正好帶了兩枝筆，借你一枝。",
    "她逛了很久的書店，最後買了十本書回家。",
    "她的桌上放著三枝筆。",
    "他的筆掉到地上了。",
    "我在圖書館借了三本小說回家看。",
    "我要在新的本子上寫今天的筆記。",
    "捷運站出來左轉，你會看到一棟白色的大樓。",
    "在師大路上有很多漂亮的餐廳。",
    "我常常去那家麵店吃牛肉麵。"
  ],
  "2": [
    "公車太慢了，我們還是搭捷運吧!",
    "這家店很有名，常常很多人在門口排隊。",
    "我們約好下午三點在出口見面。",
    "餐廳就在捷運站對面，很好找。",
    "你可以直接從學校坐公車到火車站。",
    "如果有悠遊卡就不必在捷運站買票。",
    "你得搭捷運綠線去那個捷運站，再換紅線。",
    "我想去中壢，請問車站在哪裡?",
    "從我的家到學校要換三次公車，真是太麻煩了。",
    "捷運要關門了，我們趕快上車吧！",
    "我已經在這裡等了三十分鐘的公車了。",
    "我要去台北火車站，請問我應該在哪裡轉車?",
    "下車前記得也要刷悠遊卡。",
    "上車的時候你可以問問司機這班公車到大學嗎?",
    "站牌上有公車時間嗎?",
    "你走左邊的樓梯上去三樓，左轉第二間就是你的教室。",
    "這棟大樓有兩部電梯，很方便。",
    "手扶梯旁邊有一家超商，你可以在那邊買悠遊卡。",
    "這部售票機壞了，我不能買票。",
    "想買去台中的車票請到三號售票口排隊。",
    "往左走就是1號出口了。",
    "前面那家麵店的湯麵很好吃。",
    "公車站旁邊有一家便利商店。",
    "前面路口轉彎，就到我家了。",
    "這個紅綠燈的時間很長，你慢慢走。",
    "到紅綠燈處左轉，就看到圖書館了。",
    "這個紅燈不能右轉，你要小心。",
    "我在這邊應該要直走還是右轉呢?",
    "請依照指示標誌前往登機門。",
    "要怎麼查去機場的路線?",
    "你有學校的地圖嗎?我想去圖書館。",
    "你可以在網站上查詢班次時間。",
    "請大家打開手機看看公告。",
    "上飛機應該要關掉手機才安全。",
    "不好意思，請問最近的洗手間在哪裡？",
    "我不會說中文，不知道怎麼問路。",
    "孩子很喜歡幫忙父母做家事",
    "我們搭船到綠島，風景很美。",
    "從台灣搭飛機到日本大約需要三個小時。",
    "今天不上課，我可以慢慢地吃早餐。",
    "美美帶我去學校，我很謝謝她。",
    "我暑假要去法國學習法語。",
    "義大利在歐洲南部。",
    "用悠遊卡搭火車很方便。",
    "綠島的風景很美，我拍了很多照片。",
    "我們飯店在台北的東南邊。",
    "出發前請好好地檢查行李。"
  ],
  "3": [
    "他的中文進步很快。",
    "你今天真早，有考試嗎?",
    "我上個星期的考試考得真差。",
    "我已經開始準備期末報告了。",
    "她下個月要考中文考試。",
    "我們的中文課每個星期都要考聽寫。",
    "學習中文對我來說不容易。",
    "我小學的時候跟父母去過美國。",
    "漢字的筆畫很有趣。",
    "她在高中的時候是學生會會長，很有名。",
    "我去年去過上海。",
    "他才學一個星期，就能自己去餐廳點餐了。",
    "她說話說得太快了，我聽不懂。",
    "我喜歡去夜市買東西，可以一邊逛街一邊練習中文。",
    "他來台灣三年了，他的中文非常流利。",
    "雖然天氣很冷，我還是跟他一起去爬山。",
    "現在地球的環境改變很大，天氣越來越熱了。",
    "因為媽媽不同意，所以我們只能取消計畫。",
    "他每天都看報紙，了解最新的新聞。",
    "他不喜歡吃米飯，他喜歡吃麵包。",
    "今天是一位企業家的演講，他說他家很窮，得比別人更努力才能成功。",
    "噢!這不是我的手機!我的手機呢?",
    "他跟同學常常去學生活動中心參加學校的活動。",
    "我剛剛才想起來明天有考試，可是我已經想睡覺了。",
    "今天考試的第三題你選什麼答案?",
    "今晚有很多作業要做，所以我們早一點回家吧。",
    "你要一起去咖啡店練習中文嗎?",
    "她常常半夜還在讀書。",
    "聽到我得到獎學金的好消息，媽媽很高興。",
    "我平常喜歡看書和畫畫。",
    "假日我常常和朋友去爬山。",
    "我們一起去參加社團吧!我想認識更多同學。",
    "我們很久不見了，這個週末一起去咖啡店聊天，非常開心。",
    "寫書法是一個有趣的文化活動，你要一起去參加嗎?",
    "街上到處都是廣告招牌，我覺得看起來很亂。",
    "今天學校請了一位超商的老闆來演講，我覺得很有意思。",
    "我想更了解台灣文化，所以放假的時候常常去旅行。",
    "你習慣了在台灣的生活嗎?",
    "我們學校在台北，離陽明山很近，風景很漂亮。",
    "在台灣的外國人很多，所以小吃店常常有英文的菜單。",
    "這個夜市有一些有名的小吃，你想試試看嗎?",
  ],
  "4": [
    "高美玲決定這個學期要在學校教英文。",
    "他寒假想在咖啡店打工賺學費，也可以順便練習中文。",
    "他們系的主任很關心學生，常常跟學生聊天。",
    "張老師在課堂上介紹了這個學期要學的內容。",
    "我今年二十二歲，大學剛畢業，打算先留在台灣找工作。",
    "他對語言學特別感興趣，所以想要繼續念研究所。",
    "這份實習工作讓我獲得了很多經驗，我覺得對以後找工作非常有幫助。",
    "我們在午餐時談了未來的學習計畫。",
    "畢業後，我希望能回國當中文老師。",
    "她是中文課的助教，負責幫老師改作業跟幫學生練習中文。",
    "今天的會議安排在上午九點到十一點。",
    "這門課不太容易，除了參加實習，還要準備期末的口頭報告。",
    "我們系的三年級學生已經開始做畢業專題了。",
    "暑假我打算去國外當交換生，因為畢業以後我想出國唸研究所。",
    "遇到不懂的問題時，應該趕快去請教老師。",
    "請問貴公司什麼時候舉辦徵才活動?",
    "這家公司的薪水不太高，但是福利不錯，一年還有一張回國的機票。",
    "你去參加面試的時候，應該要問這個工作的薪水怎麼算?",
    "按照課表，你今天得上八個小時的課",
    "他的太太是一位大學教授，在大學教微積分",
    "在學校打工的鐘點費不高，但是環境比較安全。",
    "他有三份工作，所以每天回來都很累。",
    "他不會說法文，可以去法國旅行嗎?",
    "亞洲人都是黑色的頭髮嗎?",
    "他在大學主修西班牙語跟日語。",
    "今天我的朋友說他要去參加英文演講比賽，拜託我跟他一起練習。",
    "他今年已經三年級了，所以在學校裡不會迷路的。",
    "按照台灣的法律，外國人可以在台灣打工嗎?",
    "他覺得一份雞排不太夠，所以又點了一份小籠包。",
    "這家公司說要參加應徵的人應該在星期五以前交履歷表。",
    "我的老闆要找我面談，了解這個工作適不適合我。",
    "他是一個華僑，在外國出生長大，不太會說中文。",
    "老師要我去他的辦公室拿今天的考卷來教室。",
    "我昨天看到你跟老闆在會議室談話。",
    "我想去你們公司應徵，你可以跟我說說公司的情形嗎?",
    "這件衣服不太適合我，我想換別的款式",
    "請你跟你的同學說明今天的功課。",
    "我打算先去日本旅行一年，然後申請日本的學生簽證，在日本念研究所",
    "老闆說月底會發薪水，我很期待。",
    "什麼時候發薪水呢?我想跟朋友一起去墾丁旅行。",
    "他的電腦壞了，所以拿到獎學金就馬上去買了新的電腦。",
    "最近我沒什麼事，所以答應朋友去幫她搬家。",
    "請在本週五之前報名參加比賽。",
    "老師準備了很多參考資料。",
    "面試時，請帶好所有必要的文件。"
  ],
  "5": [
    "我們今天去參加一場好朋友的喜酒。",
    "恭喜你們新婚快樂！",
    "美麗的新娘穿著白色婚紗走進教堂。",
    "許多人都來參加他們的婚禮。",
    "婚禮現場布置得非常浪漫。",
    "新郎穿著黑色西裝，看起來英俊極了。",
    "婚禮儀式十分正式，賓客都著正裝。",
    "客人們在大門前排隊入場。",
    "新娘用手捧著捧花微笑。",
    "請大家準備好你的照相機。",
    "新郎牽著新娘的手走上紅毯。",
    "賓客們在教堂裡站立觀禮。",
    "新娘的婚紗是純白色的，非常典雅。",
    "新郎看起來很帥，也很緊張。",
    "她的禮服上繡滿了精緻的花紋。",
    "伴娘們已經化妝完畢，準備上場。",
    "新娘高舉捧花，準備拋向客人。",
    "司儀翻開講稿，開始介紹流程。",
    "大家紛紛向新人送上祝賀。",
    "婚禮結束後，他們回到新房休息。",
    "新人已經在新房裡放好了禮物。",
    "他們細心準備每一個環節。",
    "宴會廳裡擺滿了席位。",
    "每張桌子上都有精美的擺設。",
    "大門裝飾著鮮花和彩帶。",
    "賓客的席位已經安排好。",
    "新人親手寫了謝卡寄給每位客人。",
    "牧師在講台上致詞，現場氣氛莊嚴。",
    "喜宴上擺滿了各式佳餚。",
    "新人在喜宴上敬酒感謝賓客。",
    "大人們在一旁舉杯祝福。",
    "小孩們在旁邊玩耍跑動。",
    "新郎的演講感動得大家不得了。",
    "另外，新人還準備了驚喜表演。",
    "桌上擺滿了各種糖果和甜點。",
    "儀式結束後，賓客慢慢離開。",
    "這段祝福的詩句讓人印象深刻。",
    "賓客們送上真摯的祝福。",
    "婚禮上的每一句話都充滿感動。",
    "儀式結束後大家休息一會兒。",
    "現場氣氛熱鬧，有說有笑。",
    "宴會上賓客有吃有喝，氣氛愉快。",
    "大家為新人送上百年好合的祝福。",
    "賓客們都祝他們早生貴子。"
  ],
  "6": [
    "李東健是我大學的室友。",
    "他最近搬到台北工作。",
    "我們在河邊散步聊天。",
    "這個公園裡有很多花和樹。",
    "我每天騎腳踏車去上課。",
    "這條路的風景很漂亮。",
    "這棟大樓有二十層樓。",
    "還好今天沒下雨，我們可以出門了。",
    "我的鄰居非常友善，常常打招呼。",
    "他願意幫我們搬家，真是太好了。",
    "畢業以後，我想當一名中文老師。",
    "謝謝你幫忙整理房間。",
    "你可以帶我去附近的夜市嗎？",
    "慢慢來，不用急。",
    "你可以用這支筆填表格。",
    "我可以借你的手機用一下嗎？",
    "這件事你不用擔心，我會處理。",
    "住在這裡真的很方便，附近什麼都有。",
    "我們談了兩個鐘頭才結束會議。",
    "他說只要十分鐘就能到。",
    "我們快遲到了，要趕時間了！",
    "這麼簡單的事，不必太緊張。",
    "我每天練習中文一個小時。",
    "這個社區的治安很好。",
    "我喜歡這裡的環境，很乾淨。",
    "圖書館是一個很安靜的地方。",
    "我家附近有很多便利商店。",
    "夜市裡總是非常熱鬧。",
    "他在華語中心教外國學生中文。",
    "市中心的交通很便利。",
    "這台洗衣機操作簡單又省水。",
    "我家有三間臥室。",
    "我把書桌放在窗邊。",
    "這個衣櫃可以掛很多衣服。",
    "請把椅子搬過來一點。",
    "我家客廳裡有一組沙發。",
    "沙發前擺著一張茶几。",
    "我們一起在餐桌上吃晚飯。",
    "這些家具是我搬家時新買的。",
    "水電費每個月都會分開計算。",
    "冬天用瓦斯熱水器很方便。",
    "請問這個月的費是多少？",
    "房租已經包水電和網路了。",
    "我家有穩定的網路可以上課。",
    "房東人很好，常幫我們處理問題。",
    "簽合約前一定要仔細看內容。",
    "我們下週就要簽新合約了。"
  ],
  "7": [
    "請記得把垃圾分類後再丟進桶子裡。",
    "每天晚上十點前要把垃圾倒出去。",
    "這個瓶子還可以回收，不要丟掉。",
    "這個地區每天早上收垃圾。",
    "我以為今天不用上課，結果遲到了。",
    "他以為今天是星期日，結果公司沒放假。",
    "請記得做好垃圾分類。",
    "這件事雖然麻煩，但很重要。",
    "請幫我拿個袋子來裝東西。",
    "這兩張照片看起來一樣，但其實不同。",
    "她把皮包忘在公車上了。",
    "我今天忘記帶學生證出門了。",
    "他看到老朋友後馬上走過去打招呼。",
    "老師看到我站在門口，就走過來問我有什麼事。",
    "我過去問他一下有沒有問題。",
    "你可以過來幫我一下嗎？",
    "他說他晚上十點前會回來。",
    "我東西忘在教室了，要回去拿。",
    "請你幫我拿一下那本書。",
    "她的包包裡有一個便當盒。",
    "他把所有東西裝進紙箱裡。",
    "我在口袋裡找到了發票。",
    "請把喝完的飲料瓶丟進去這個回收桶。",
    "這件衣服太髒了，要洗一洗。",
    "你記得明天要交報告嗎？",
    "我的鑰匙不見了，找不到了。",
    "我希望這次考試能考得好一點。",
    "大學生活讓我感覺更有自由。",
    "他一邊吃飯一邊看手機。",
    "我突然想起來今天是媽媽的生日。",
    "他帶了一袋水果來看我。",
    "我昨天花了一整天整理房間。",
    "請把這些空瓶子分類放好。",
    "這些紙杯只能用一次。",
    "這家店的飲料都不加糖。",
    "他喝完水後就出門了。",
    "這些舊報紙可以丟掉了。",
    "你應該多運動，對身體好。",
    "他剛下課，現在才回來。",
    "我很想去旅行，不過工作太忙。",
    "我常常在圖書館遇到他。",
    "他的房間總是亂七八糟的。",
    "以後出門記得帶鑰匙。",
    "我已經習慣每天早起了。"
  ],
  "8": [
    "因為工作太多，他常常需要加班到很晚。",
    "上下班時間的交通非常擁擠。",
    "住在市中心真的很方便，去哪裡都很近。",
    "我的鄰居是一位很友善的阿姨。",
    "這家餐廳的用餐環境非常乾淨舒適。",
    "房東每個月都會來收房租。",
    "出國前記得檢查行李是否帶齊。",
    "我們這週要去參觀台灣歷史博物館。",
    "明天要演講，他感到非常緊張。",
    "她已經習慣每天早起運動了。",
    "在台北搭地鐵比開車方便多了。",
    "晚餐前我去超市買了一些食材。",
    "他們決定租一間離學校近的公寓。",
    "下個月我要搬家到新北市。",
    "手機支付讓生活變得更方便了。",
    "她花了一個下午整理書桌。",
    "我想去台灣老街走一趟，親自體驗傳統文化。",
    "參加這次活動後，我認識了許多來自不同國家的朋友。",
    "春節是一個充滿傳統習俗的重要節日。",
    "他對台灣的夜市文化感到非常好奇。",
    "明天我們要參加一場廟會遊行。",
    "學校每個月都會舉辦一次文化體驗活動。",
    "老師幫我們安排了一個週末的校外教學行程。",
    "這個地方有很多老房子，非常有歷史感。",
    "夜市裡人很多，又熱鬧又有趣。",
    "這道菜加了香菜，味道特別香。",
    "廟會上有舞龍舞獅等傳統表演。",
    "我們提前一個星期就開始準備文化展覽了。",
    "他第一次搭捷運，感覺很新鮮。",
    "這場表演非常精彩，大家都鼓掌叫好。",
    "我記得去年我們也來過這個地方。",
    "這裡風景很好，很多人來拍照打卡。",
    "他在社群網站上分享了活動的照片和心得。"
  ],
  "9": [
    "春假快到了，我們全家計劃去旅行。",
    "這家餐廳的菜很好吃，我很喜歡。",
    "我們晚上七點到台北車站集合。",
    "這間餐廳的特色是使用在地食材。",
    "我今天睡得不夠，整天都很累。",
    "下次有機會再一起去爬山吧！",
    "請記得明天帶你的護照。",
    "我每天晚上花一小時寫功課。",
    "他正在準備下星期的專題報告。",
    "學校下個月放假兩個星期。",
    "我打算這個週末整理房間。",
    "這次的旅行是姐姐安排的。",
    "這是一個適合野餐的好地方。",
    "暑假時我會回南部老家看爺爺奶奶。",
    "台灣北部冬天比較常下雨。",
    "中部的天氣四季分明，很舒服。",
    "東部有很多自然景觀，風景很美。",
    "西部的城市比較熱鬧。",
    "我們去海邊玩水還堆了沙堡。",
    "山上的空氣很新鮮，適合散步。",
    "他已經預訂了下週的高鐵票。",
    "我們住的旅館靠近夜市，交通方便。",
    "這家民宿的老闆非常親切。",
    "你需要幫忙的時候可以找我。",
    "我幫大家訂了五人座的餐廳。",
    "現在用網路買東西非常方便。",
    "太晚訂票就訂不到好位置了。",
    "這家牛肉麵店在當地很有名。",
    "那部電影太熱門了，票很快賣光。",
    "老師推薦我們去看那場展覽。",
    "搬家的時候他主動來幫忙。",
    "過馬路時要注意來車。",
    "我喜歡自由行，可以自己安排行程。",
    "旅行社提供了各種國內外旅遊方案。",
    "他們選擇跟團旅遊，省時又省力。",
    "學生們參觀了歷史博物館。",
    "這裡是當地最受歡迎的旅遊景點之一。",
    "山上的風景讓人心情愉快。",
    "她喜歡在旅行時照相留念。",
    "爸爸今天開車載我們去動物園。",
    "我們搭地鐵到市政府站下車。",
    "我每天早上搭公車上學。",
    "你想喝咖啡還是果汁？"
  ],
  "10": [
    "馬丁學中文已經三年了。",
    "她背著一個紅色的包去學校。",
    "我最喜歡媽媽包的餃子，味道很好。",
    "請進來前把鞋子脫掉。",
    "這雙鞋穿起來很舒服。",
    "睡覺前記得關燈。",
    "他一進門就喊我的名字。",
    "過年時奶奶會做香脆的春捲。",
    "我不太敢吃太辣的泡菜。",
    "我們全家每天晚上在飯廳吃飯。",
    "他把書放在桌子下。",
    "吃飯前要先洗手。",
    "週末我喜歡和媽媽一起做菜。",
    "今天晚餐我們吃煮水餃。",
    "這鍋湯煮了兩個小時才完成。",
    "這台電視好像壞了，打不開。",
    "他不小心把杯子打破了。",
    "這種餃子的餡兒是高麗菜和豬肉。",
    "這個枕頭太扁了，睡起來不舒服。",
    "做這道菜需要準備很多材料。",
    "這家餐廳有十道菜可以選擇。",
    "我吃了三碗飯，現在很飽。",
    "桌上的餅乾已經吃光了。",
    "這口鍋子可以用來煮湯。",
    "她用筷子夾菜的速度很快。",
    "請幫我拿一個大一點的碗。",
    "我想去韓國旅行看櫻花。",
    "他雖然五十歲了，但看不出來。",
    "這碗酸辣湯味道很地道。",
    "這學期我修了五門課。",
    "趁現在天氣好，我們去爬山吧。",
    "餃子的皮不能太厚也不能太薄。",
    "你要不要嚐嚐我做的蛋糕？",
    "這道湯加了大白菜更清甜。",
    "煮湯的時候可以加一點鹽。",
    "你覺得這道菜鹹嗎？是不是鹽放太多？",
    "她正在廚房拌沙拉。",
    "這道菜加了很多辣椒，超辣。",
    "煮菜前要先準備好調味料。",
    "他把便當裝進袋子裡。",
    "那個杯子是用玻璃做的。",
    "我第一次吃壽司是在東京。",
    "他長得像爸爸。",
    "市場裡有很多各地的美食食物。",
    "這道菜看起來難，其實做起來很簡單。"
  ],
  "11": [
    "除了這家餐廳，你還想去其他地方嗎？",
    "這個假期我打算去海邊玩。",
    "冬天泡溫泉很舒服。",
    "我建議你帶把雨傘。",
    "這場演唱會的票賣完了。",
    "我會考慮你的提議。",
    "回家的路上我順便買了牛奶。",
    "日月潭是一個很漂亮的湖。",
    "台灣有多個不同的原住民族群。",
    "我昨天去了一趟超市。",
    "我先去朋友家，後來又去逛街。",
    "過馬路時要注意安全。",
    "小朋友在沙灘上玩耍。",
    "我的錢包掉了，找不到了。",
    "我的手機不見了！",
    "他的腳踏車被人偷了。",
    "開車時一定要注意安全。",
    "這本書很值得一讀。",
    "墾丁有很美麗的海灘。",
    "我下週要去台中出差。",
    "日月潭是著名的旅遊景點。",
    "夏天最適合參加水上活動。",
    "這裡是國家級風景區。",
    "他昨天沒來，今天又沒來。",
    "這首歌遍地都在播放。",
    "我們住在海邊的民宿。",
    "他今天的運氣很好。",
    "他騎摩托車去上班。",
    "台灣屬於熱帶和亞熱帶氣候。",
    "這座花園裡有各種植物。",
    "我所有的衣服都在衣櫃裡。",
    "我白天在公司工作。",
    "他喜歡躺在沙發上看書。",
    "黃昏的海邊風景很美。",
    "一條魚在水裡游。",
    "這條街有很多餐廳。",
    "他喜歡喝冰啤酒。",
    "牆上掛著一幅畫。",
    "海邊的夕陽非常浪漫。",
    "我的家鄉在山裡。",
    "暑假有很多觀光客來這裡玩。",
    "冬天我喜歡在院子裡曬太陽。",
    "他第一次玩水上摩托車，覺得很刺激。",
    "他愛上了這座美麗的城市。",
    "他在旅行中愛上了潛水。"
  ],
  "12": [
    "我買了一雙新鞋子，準備去運動。",
    "商店早上九點開門。",
    "他因為健康原因開始吃素食。",
    "我們常常在學校附近的速食店吃午餐。",
    "這個答案是錯的，請再想一想。",
    "這家餐廳的牛肉很好吃。",
    "欸，你看那邊有一隻可愛的小狗！",
    "我媽媽不讓我太晚回家。",
    "我奶奶從年輕時就開始吃素。",
    "我最喜歡吃牛肉漢堡。",
    "天氣突然變冷了，記得穿外套。",
    "這隻小貓越來越胖了。",
    "這家餐廳的素菜非常新鮮。",
    "這道菜太油膩了，不適合常吃。",
    "這家店的衣服有各種各樣的顏色。",
    "小朋友對新玩具總是很好奇。",
    "那個女孩正在公園裡玩球。",
    "我每天都會吃一些青菜。",
    "他最近運動很多，看起來更瘦了。",
    "我的室友很喜歡打籃球。",
    "這道菜需要一點豬肉和蔬菜。",
    "西方的飲食和亞洲不同。",
    "我完全不知道該怎麼回答這個問題。",
    "這碗湯太鹹了。",
    "我喜歡吃炸雞排。",
    "今天我們要烤蛋糕。",
    "午餐我只吃了一碗沙拉。",
    "我們放學後常去麥當勞吃漢堡。",
    "這家速食店24小時營業。",
    "只要你努力，就會有好結果。",
    "我最討厭吃苦瓜了。",
    "這家餐廳有三種套餐，每餐都很好吃。",
    "這個國家的主要宗教是佛教。",
    "他們之間有很好的朋友關係。",
    "我喜歡吃熱騰騰的薯條。",
    "這道菜的作法很簡單。",
    "他跑得越快，我就追得越辛苦。",
    "這個問題很簡單，我來回答。",
    "媽媽喜歡蒸魚來吃。",
    "這些蔬菜是有機的，沒有農藥。",
    "這家超市賣很多進口食品。",
    "地球是我們的家。",
    "工廠排出的廢水會汙染河流。",
    "這次颱風造成的損失非常嚴重。",
    "餐廳要注意環境衛生。",
    "早餐要吃得有營養。",
    "他喜歡打籃球、游泳什麼的。"
  ],
  "13": [
    "林愛麗是我的同班同學。",
    "我的手機不小心掉在地上了。",
    "他低頭看手機，沒注意前面的車。",
    "他在群組裡傳了一張照片。",
    "我們一起過馬路。",
    "我收到了一封朋友寄來的簡訊。",
    "這款手機有很多新功能。",
    "他因為被誤會而很生氣。",
    "他大聲叫了我的名字。",
    "媽媽罵了我，因為我沒寫作業。",
    "我每天都去健身房運動。",
    "別擔心啦，一切都會好起來的。",
    "我需要查一下今天的天氣預報。",
    "我們搭乘早上十點的班機出國。",
    "我想訂位兩個人，晚上七點。",
    "這台電腦沒電了，快充電。",
    "我的手機需要充電。",
    "他太糊塗了，總是忘東忘西。",
    "喔，原來是你打電話來的。",
    "她下個月要去義大利旅行。",
    "誰把我的鉛筆盒拿走了？",
    "我在路上撿到一個錢包。",
    "他在紙條上留下了電話號碼。",
    "現在大家都離不開網路。",
    "這裡昨天發生了一起車禍。",
    "這件事情需要馬上處理。",
    "我剛剛收到一個好消息。",
    "我透過朋友認識了他。",
    "他想去看看世界上不同的地方。",
    "我們要學會節省用水。",
    "我每天早上七點起床。",
    "醫生正在檢查病人的狀況。",
    "我今天收到了三封郵件。",
    "他立刻打電話報警。",
    "你可以把照片上傳到雲端。",
    "經過修理，手機已恢復正常。",
    "我想和你談一談未來的計畫。",
    "現代人很依賴科技產品。",
    "我喜歡戶外活動，比方說登山和游泳。",
    "只要努力，就一定能做到。",
    "他獲得了第一手的新聞資料。",
    "他急著出門，忘了帶鑰匙。",
    "他微笑著向老師打招呼。",
    "我們面對面談話比較清楚。"
  ],
  "14": [
    "我將來想成為一名老師。",
    "學校正在徵求志工。",
    "他是一位經驗豐富的中文教師。",
    "我認為這個方法很好。",
    "他大學畢業後去國外工作。",
    "科技的發展非常快速。",
    "他太忙了，連休息的時間都沒有。",
    "你的想法很有創意。",
    "他不但會唱歌，還會跳舞。",
    "雖然失敗了，他還是決定繼續努力。",
    "這款手機很容易使用。",
    "他希望能實現自己的夢想。",
    "老闆親自招待外國客人。",
    "他打算申請國外的研究所。",
    "朋友們週末會聚在一起吃飯。",
    "我下個月要去香港旅行。",
    "上海是一個國際化的大城市。",
    "說到美食，我最喜歡火鍋。",
    "我念完這本書後會借給你。",
    "這家公司在台北有一個分公司。",
    "他搬家時非常捨不得離開朋友。",
    "好久不見，我們週末聚一聚吧！",
    "我當時正在準備考試。",
    "學中文時，聲調非常重要。",
    "這個字的發音很特別。",
    "老師不準學生上課遲到。",
    "這是一家國際企業。",
    "他負責公司的財務管理。",
    "我在中文系上課。",
    "這個國家的經濟正在成長。",
    "謝謝你給我的幫助。",
    "這件事和你沒有有關。",
    "中文的語法和英文不同。",
    "他正在進行一項新的研究。",
    "他計劃將來到國外教書。",
    "這個學習方法很有效。",
    "學中文的目的是和更多人交流。",
    "這是一場大型的國際會議。",
    "他擅長中英文翻譯。",
    "他在政府部門負責外交工作。",
    "這家公司需要招募新人員。",
    "暑假我參加了幾個充實的課程。",
    "我的專業是中文教學。",
    "他在語言方面很有能力。",
    "我有一個朋友住在加拿大。",
    "他在大學念企管系。",
    "她將來想研究國際關係。"
  ],
  "15": [
    "春節是中國最重要的傳統節日之一。",
    "我伯伯住在台中。",
    "我們全家一起吃年夜飯慶祝新年。",
    "不好意思，打電話打擾你了。",
    "他有一個可愛的女兒。",
    "她打算明年去國外留學。",
    "過年的時候，家人一起圍爐吃火鍋。",
    "這個字的意思是什麼？",
    "我們全家都去奶奶家過年。",
    "這個故事很適合小孩子聽。",
    "這些紅色裝飾代表吉祥和平安。",
    "她的年紀和我差不多。",
    "我們每年都回老家一起過年。",
    "除夕夜我們一家人會守歲到半夜。",
    "他看電視看著看著就睡著了。",
    "爺爺給我一個紅包，裡面有壓歲錢。",
    "過年時大家互相說恭喜發財。",
    "事情已經解決好了。",
    "中秋節是中國重要的傳統節日之一。",
    "過年前我們會一起打掃房子。",
    "我買了一件新衣服，另外還買了鞋子。",
    "過年時大家會在門上貼春聯。",
    "除夕是農曆年的最後一天。",
    "過年時媽媽會做甜年糕。",
    "桌上擺滿了新鮮的橘子。",
    "大家一起聊天、看電視來守歲。",
    "對於這件事，有不同的說法。",
    "我今天回家比較晚。",
    "他每天過得很充實，活得很活潑。",
    "祝你旅途平安！",
    "天氣很冷，出門要多穿衣服。",
    "過年時我們去親戚家拜年。",
    "他又忘記帶手機了。",
    "他從椅子上站起來。",
    "世界上有很多地方住著華人。",
    "請把這張海報貼上牆壁。",
    "祝大家新年快樂、年年有餘！",
    "希望你工作順利、步步高升。",
    "過年時大家互祝大吉大利。",
    "小朋友喜歡在除夕夜放鞭炮。",
    "大年初一大家都會早起拜年。",
    "大年初五是迎財神的日子。"
  ]
};

  function nowString(){ const t=new Date(),p=n=>String(n).padStart(2,'0'); return `${t.getFullYear()}-${p(t.getMonth()+1)}-${p(t.getDate())} ${p(t.getHours())}:${p(t.getMinutes())}:${p(t.getSeconds())}`; }
  function normalize(str){ if(!str) return ""; return str.replace(/[\s\p{P}\p{S}]/gu,'').replace(/[Ａ-Ｚａ-ｚ０-９]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)); }

  // ---- Checkbox UI ----
  function renderLessonChecks(){
    const box=document.getElementById("lessonChecks");
    box.innerHTML="";
    Object.entries(lessons).forEach(([k,arr])=>{
      const id="chk_"+btoa(encodeURIComponent(k)).replace(/=+/g,"");
      const div=document.createElement("div");
      div.className="check-item";
      div.innerHTML=`<input type="checkbox" id="${id}" name="lessonChk" value="${k}">
                     <label for="${id}">${k}（${(arr||[]).length} 句）</label>`;
      box.appendChild(div);
    });
    updateCounts();
  }
  function getCheckedLessons(){
    return Array.from(document.querySelectorAll('input[name="lessonChk"]:checked')).map(el=>el.value);
  }
  function checkAllLessons(){
    document.querySelectorAll('input[name="lessonChk"]').forEach(el=>el.checked=true);
    updateCounts();
  }
  function uncheckAllLessons(){
    document.querySelectorAll('input[name="lessonChk"]').forEach(el=>el.checked=false);
    updateCounts();
  }
  function updateCounts(){
    const keys=getCheckedLessons();
    const pool=[]; keys.forEach(k=>{ (lessons[k]||[]).forEach(s=>pool.push(s)); });
    document.getElementById("selCount").innerText = keys.length;
    document.getElementById("sentCount").innerText = pool.length;
  }
  document.addEventListener("change", (e)=>{
    if(e.target && e.target.name==="lessonChk"){ updateCounts(); }
  });
  renderLessonChecks();

  // ---- Diff / scoring ----
  function diffAlign(aRaw,bRaw){
    const a=normalize(aRaw), b=normalize(bRaw), n=a.length, m=b.length;
    const dp=Array.from({length:n+1},()=>Array(m+1).fill(0));
    const bt=Array.from({length:n+1},()=>Array(m+1).fill(null));
    for(let i=0;i<=n;i++){ dp[i][0]=i; bt[i][0]='U'; }
    for(let j=0;j<=m;j++){ dp[0][j]=j; bt[0][j]='L'; }
    for(let i=1;i<=n;i++){ for(let j=1;j<=m;j++){
      const cost=a[i-1]===b[j-1]?0:1;
      const d=dp[i-1][j-1]+cost, u=dp[i-1][j]+1, l=dp[i][j-1]+1;
      const best=Math.min(d,u,l); dp[i][j]=best; bt[i][j]=best===d?'D':best===u?'U':'L';
    }}
    let i=n,j=m,ops=[]; while(i>0||j>0){ const mv=bt[i][j];
      if(mv==='D'){ ops.push({type:a[i-1]===b[j-1]?'EQ':'SUB', a:a[i-1], b:b[j-1]}); i--; j--; }
      else if(mv==='U'){ ops.push({type:'DEL', a:a[i-1], b:''}); i--; }
      else { ops.push({type:'INS', a:'', b:b[j-1]}); j--; }
    }
    ops.reverse(); return {distance:dp[n][m], ops, baseLen:Math.max(1,a.length)};
  }
  function renderDiffHTML(targetRaw, heardRaw){
    const {distance, ops, baseLen}=diffAlign(targetRaw, heardRaw);
    const A=[], B=[];
    for(const op of ops){
      if(op.type==='EQ'){ A.push(`<span class="ok">${op.a}</span>`); B.push(`<span class="ok">${op.b}</span>`); }
      else if(op.type==='SUB'){ A.push(`<span class="highlight" title="應為：${op.a}">${op.a}</span>`); B.push(`<span class="highlight" title="辨為：${op.b}">${op.b}</span>`); }
      else if(op.type==='DEL'){ A.push(`<span class="highlight" title="未唸出：${op.a}">${op.a}</span>`); B.push(`<span class="highlight" title="未唸出">∅</span>`); }
      else if(op.type==='INS'){ A.push(`<span class="highlight" title="多唸">∅</span>`); B.push(`<span class="highlight" title="多唸：${op.b}">${op.b}</span>`); }
    }
    const pct=Math.round(Math.max(0,1-distance/baseLen)*100);
    const html=`<div class="row"><span class="label">例句：</span>${A.join('')}</div><div class="row"><span class="label">辨識：</span>${B.join('')}</div>`;
    return { html, pct };
  }
  function feedbackByScore(pct){
    if (pct>=95) return "太棒了！幾乎完全正確，維持清晰的咬字與穩定的語速。Excellent! Nearly perfect accuracy—keep your articulation clear and pace steady.";
    if (pct>=85) return "很不錯！再注意個別字的收尾與連音，放慢一點更穩。Great work! Watch final consonants and liaison; a slightly slower pace adds stability.";
    if (pct>=70) return "有進步！建議先跟著示範慢速朗讀，針對高光字多練幾次。Good progress! Shadow the demo slowly and practice the highlighted characters.";
    if (pct>=50) return "別急，先分段朗讀並重複練習，再完整朗讀一次。Don't rush—read in chunks, repeat, then attempt a full read.";
    return "加油！先聽示範兩遍，逐字跟讀，確認每個字都有發到位。Keep at it! Listen twice, echo word-by-word, and ensure each syllable lands.";
  }
  function quizOverallFeedback(totalPct){
    if (totalPct>=95) return { zh:"太棒了！幾乎完全正確，維持清晰的咬字與穩定的語速。", en:"Excellent! Nearly perfect accuracy—keep your articulation clear and pace steady." };
    if (totalPct>=85) return { zh:"很不錯！再注意個別字的收尾與連音，放慢一點更穩。", en:"Great work! Watch final consonants and liaison; a slightly slower pace adds stability." };
    if (totalPct>=70) return { zh:"有進步！建議跟著示範慢速朗讀，針對高光字多練幾次。", en:"Good progress! Shadow the demo slowly and practice the highlighted characters." };
    if (totalPct>=50) return { zh:"別急，先分段朗讀並重複練習，再完整朗讀一次。", en:"Don't rush—read in chunks, repeat, then attempt a full read." };
    return { zh:"加油！先聽示範兩遍，逐字跟讀，確認每個字都有發到位。", en:"Keep at it! Listen twice, echo word-by-word, and ensure each syllable lands." };
  }

  // ---- Pool from checked lessons ----
  function poolFromChecked(){
    const keys=getCheckedLessons();
    const pool=[]; keys.forEach(k=>{ (lessons[k]||[]).forEach(s=>pool.push([k,s])); });
    return pool;
  }

  // ---- Practice ----
  let currentSentence=""; let rec=null;
  const practiceRecords=[];
  function newSentence(){
    const pool=poolFromChecked(); if(pool.length===0){ alert("請先勾選至少一個課次。"); return; }
    const [key,s]=pool[Math.floor(Math.random()*pool.length)];
    currentSentence=s; document.getElementById("sentence").innerText=`（${key}）${s}`;
    document.getElementById("result").innerText="尚無結果";
    document.getElementById("diff").innerText="尚無結果";
    document.getElementById("accuracy").innerText="—";
    document.getElementById("feedback").innerText="";
  }
  function playSentence(){
    if(!currentSentence){ alert("請先生成句子！"); return; }
    const u=new SpeechSynthesisUtterance(currentSentence); u.lang="zh-TW"; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  function startRecognition(){
    if(!('webkitSpeechRecognition'in window)){ alert("此瀏覽器不支援語音辨識，請使用 Chrome。"); return; }
    if(!currentSentence){ alert("請先按「換一句」生成句子！"); return; }
    rec=new webkitSpeechRecognition(); rec.lang="zh-TW"; rec.continuous=false; rec.interimResults=false;
    rec.onresult=function(e){
      const heard=e.results[0][0].transcript||"";
      document.getElementById("result").innerText=heard;
      const {html,pct}=renderDiffHTML(currentSentence, heard);
      document.getElementById("diff").innerHTML=html;
      document.getElementById("accuracy").innerText=pct+"%";
      document.getElementById("feedback").innerText=feedbackByScore(pct);
      const name=document.getElementById("studentName").value.trim();
      const sid=document.getElementById("studentId").value.trim();
      practiceRecords.push({ time:nowString(), name, sid, sentence:currentSentence, recognized:heard, accuracy:pct, feedback:feedbackByScore(pct) });
      toggleRecButtons(false);
    };
    rec.onend=function(){ toggleRecButtons(false); };
    rec.start(); toggleRecButtons(true);
  }
  function stopRecognition(){
    if(rec){ try{ rec.stop(); }catch(e){} }
    toggleRecButtons(false);
  }
  function toggleRecButtons(recording){
    document.getElementById("btnStart").disabled=recording;
    document.getElementById("btnStop").disabled=!recording;
  }
  function downloadTxt(){
    if(practiceRecords.length===0){ alert("尚無成績可下載。請先完成一次錄音練習。"); return; }
    const lines=["【中文口語發音練習（Book2_A2）｜成績單】",`匯出時間：${nowString()}`,"","姓名\t學號\t時間\t例句\t辨識結果\t正確率(%)\t建議與回饋"];
    const clean=s=>(s||"").replace(/\r?\n/g," ").trim();
    practiceRecords.forEach(r=>lines.push(`${clean(r.name)}\t${clean(r.sid)}\t${r.time}\t${clean(r.sentence)}\t${clean(r.recognized)}\t${r.accuracy}\t${clean(r.feedback)}`));
    const blob=new Blob(["\uFEFF"+lines.join("\n")],{type:"text/plain;charset=utf-8;"}), url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="practice_results.txt"; a.click(); URL.revokeObjectURL(url);
  }

  // ---- Quiz ----
  let quizQueue=[], quizIndex=-1, quizHeard="", quizRec=null;
  const quizRecords=[];
  function setQuizState(t){ document.getElementById("quizState").innerText=t; }
  function startQuiz(){
    const pool=poolFromChecked().map(([k,s])=>s); if(pool.length<1){ alert("請先勾選至少一個課次。"); return; }
    quizQueue=[]; const temp=[...pool];
    for(let i=0;i<3;i++){ if(temp.length===0) break; const idx=Math.floor(Math.random()*temp.length); quizQueue.push(temp.splice(idx,1)[0]); }
    if(quizQueue.length<3){ while(quizQueue.length<3 && pool.length>0) quizQueue.push(pool[Math.floor(Math.random()*pool.length)]); }
    quizRecords.length=0; quizIndex=-1; quizHeard=""; document.getElementById("quizSummary").style.display="none"; document.getElementById("quizFeedback").innerText="—";
    setQuizState("已抽題，按「開始錄音」後作答，完成請按「提交本題」。"); nextQuiz();
  }
  function nextQuiz(){
    quizIndex++; if(quizIndex>=quizQueue.length){ finishQuiz(); return; }
    const s=quizQueue[quizIndex]; document.getElementById("quizSentence").innerText=`第 ${quizIndex+1} 題：${s}`;
    document.getElementById("quizHeard").innerText="—"; document.getElementById("quizDiff").innerText="（高光差異會顯示在這裡）"; quizHeard="";
    setQuizState(`作答中（第 ${quizIndex+1}/3 題）`);
  }
  function quizPlay(){ const txt=quizQueue[quizIndex]; if(!txt){ alert("請先開始測驗。"); return; } const u=new SpeechSynthesisUtterance(txt); u.lang="zh-TW"; speechSynthesis.cancel(); speechSynthesis.speak(u); }
  function quizRecord(){
    if(!('webkitSpeechRecognition'in window)){ alert("此瀏覽器不支援語音辨識，請使用 Chrome。"); return; }
    const txt=quizQueue[quizIndex]; if(!txt){ alert("請先開始測驗。"); return; }
    quizRec=new webkitSpeechRecognition(); quizRec.lang="zh-TW"; quizRec.continuous=false; quizRec.interimResults=false; quizRec.onresult=function(e){ quizHeard=e.results[0][0].transcript||""; document.getElementById("quizHeard").innerText=quizHeard||"（未取得辨識）"; const {html}=renderDiffHTML(txt,quizHeard); document.getElementById("quizDiff").innerHTML=html; toggleQuizRecButtons(false); }; quizRec.onend=function(){ toggleQuizRecButtons(false); }; quizRec.start(); toggleQuizRecButtons(true);
  }
  function quizStop(){
    if(quizRec){ try{ quizRec.stop(); }catch(e){} }
    toggleQuizRecButtons(false);
  }
  function toggleQuizRecButtons(recording){
    document.getElementById("btnQuizStart").disabled=recording;
    document.getElementById("btnQuizStop").disabled=!recording;
  }
  function quizSubmit(){
    const txt=quizQueue[quizIndex]; if(!txt){ alert("請先開始測驗。"); return; }
    if(!quizHeard){ alert("請先錄音再提交本題。"); return; }
    const {html,pct}=renderDiffHTML(txt, quizHeard);
    quizRecords.push({ idx:quizIndex+1, sentence:txt, recognized:quizHeard, pct, diffHTML:html });
    nextQuiz();
  }
  function finishQuiz(){
    setQuizState("測驗完成");
    const total=Math.round(quizRecords.reduce((s,r)=>s+r.pct,0)/quizRecords.length);
    document.getElementById("quizTotal").innerText=total+"%";
    const fb=quizOverallFeedback(total); document.getElementById("quizFeedback").innerText=`${fb.zh} / ${fb.en}`;
    const name=(document.getElementById("studentName").value||"").trim();
    const sid=(document.getElementById("studentId").value||"").trim();
    const who=(name||sid)? `${name} / ${sid}` : "（未填）";
    document.getElementById("quizWho").innerText = who;
    const tbody=document.querySelector("#quizTable tbody"); tbody.innerHTML="";
    quizRecords.forEach(r=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${r.idx}</td><td>${r.diffHTML}</td><td>${r.pct}%</td>`; tbody.appendChild(tr); });
    document.getElementById("quizSummary").style.display="block";
  }

  function downloadQuizTXT(){
    if(quizRecords.length!==3){ alert("請先完成一次 3 題的測驗。"); return; }
    const total=Math.round(quizRecords.reduce((s,r)=>s+r.pct,0)/quizRecords.length), fb=quizOverallFeedback(total);
    const name=(document.getElementById("studentName").value||"").trim();
    const sid=(document.getElementById("studentId").value||"").trim();
    const lines=["【中文口語發音練習（Book2_A2）｜成績單】",`匯出時間：${nowString()}`,`姓名：${name}`,`學號：${sid}`,`總正確率：${total}%`,`總評（中文）：${fb.zh}`,`Overall Feedback (EN): ${fb.en}`,"","題次\t例句\t辨識結果\t正確率(%)"];
    const clean=s=>(s||"").replace(/\r?\n/g," ").trim();
    quizRecords.forEach(r=>lines.push(`${r.idx}\t${clean(r.sentence)}\t${clean(r.recognized)}\t${r.pct}`));
    const blob=new Blob(["\uFEFF"+lines.join("\n")],{type:"text/plain;charset=utf-8;"}), url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="quiz_results.txt"; a.click(); URL.revokeObjectURL(url);
  }
  function downloadQuizCSV(){
    if(quizRecords.length!==3){ alert("請先完成一次 3 題的測驗。"); return; }
    const total=Math.round(quizRecords.reduce((s,r)=>s+r.pct,0)/quizRecords.length), fb=quizOverallFeedback(total);
    const name=(document.getElementById("studentName").value||"").trim();
    const sid=(document.getElementById("studentId").value||"").trim();
    const rows=[["題次","例句","辨識結果","正確率(%)"].join(",")];
    const esc = s => '"' + String(s || "").replace(/"/g,'""') + '"';
    quizRecords.forEach(r=>rows.push([r.idx, esc(r.sentence), esc(r.recognized), r.pct].join(",")));
    rows.push(["", "", "", ""].join(","));
    rows.push(["姓名", name, "", ""].join(","));
    rows.push(["學號", sid, "", ""].join(","));
    rows.push(["總正確率(%)", total, "", ""].join(","));
    rows.push(["總評(中文/EN)", esc(fb.zh+" / "+fb.en), "", ""].join(","));
    const csv="\uFEFF"+rows.join("\n"); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}), url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="quiz_results.csv"; a.click(); URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
